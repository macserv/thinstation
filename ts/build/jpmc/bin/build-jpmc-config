#!/bin/bash
#
#  JPMC Build Script
#



####
# Configuration Parameters
##

#TODO: Make local parameters lowercase.

THINSTATION_BUILD_OPTIONS="--autodl --license ACCEPT ${*}"  # Call this script with `--allmodules --savedir` when debugging.
BUILT_SYSLINUX_PATH="/build/boot-images/syslinux/boot/syslinux"
JPMC_PATH="/build/jpmc"
JPMC_SYSLINUX_PATH="${JPMC_PATH}/syslinux"

JPMC_CONSOLE_FONT_FILE="SCRAWL_W.PSF" # Must be named in DOS 8.3 format, and located in /build/jpmc/syslinux/psf

BUILD_DATE="$(date '+%Y%m%d%H%M%S')"
BUILD_VERSION=$(git describe --tags --dirty=.patched --abbrev=8 | perl -pe 's/(\d(?:\.\d){0,2})-(\d+)-g([[:xdigit:]]+)?(.patched)?/\1+\2:\3\4/')



####
# Setup timing
##

# Beep and echo when the shell running this script is EXITed.
trap 'echo -e "\a" ; times ; date' EXIT



####
# Functions
##


adjust_timezone()
{
    local TIMEZONE_LINK     ;     TIMEZONE_LINK="/etc/localtime"
    local TIMEZONE_TARGET   ;   TIMEZONE_TARGET="$(readlink "${TIMEZONE_LINK}")"
    local TIMEZONE_REQUIRED ; TIMEZONE_REQUIRED="/usr/share/zoneinfo/America/New_York" #TODO: Move REQUIRED to config above.
    
    [[ -L "${TIMEZONE_LINK}" && "${TIMEZONE_TARGET}" == "${TIMEZONE_REQUIRED}" ]] && { return ; }

    echo "[ERROR] Time zone currently set to ${TIMEZONE_TARGET:t}.  Resetting to ${TIMEZONE_REQUIRED:t}."
    
    rm -f "${TIMEZONE_LINK}"                        || { echo "[ERROR] Failed to remove time zone link." ; return 1 ; }
    ln -s "${TIMEZONE_REQUIRED}" "${TIMEZONE_LINK}" || { echo "[ERROR] Failed to establish time zone link." ; return 1 ; }
}


build_thinstation()
{
    cd /build || { echo "[ERROR] Could not change directory to /build." ; return 1 ; }
    ./build ${THINSTATION_BUILD_OPTIONS}
}


copy_syslinux_font()
{
    local FONT_PATH="${JPMC_SYSLINUX_PATH}/psf/${JPMC_CONSOLE_FONT_FILE}"
    
    [ -f "${FONT_PATH}" ]                        || { echo "[WARNING] Specified PSF font not found at ${FONT_PATH}." ; return 1 ; }
    cp "${FONT_PATH}" "${BUILT_SYSLINUX_PATH}/." || { echo "[WARNING] Failed to copy font to boot image." ; return 1 ; }
}


add_syslinux_font_directive()
{
    local SYSLINUX_CFG_PATH ; SYSLINUX_CFG_PATH="${BUILT_SYSLINUX_PATH}/syslinux.cfg"
    local FONT_DIRECTIVE    ;    FONT_DIRECTIVE="FONT ${JPMC_CONSOLE_FONT_FILE}\n"

    sed -i "1s|^|${FONT_DIRECTIVE}|" "${SYSLINUX_CFG_PATH}" || { echo "[WARNING] FONT directive insertion failed." ; return 1 ; }
}


edit_syslinux_product_text()
{
    local TEMPLATE_PRODUCT_PATH ; TEMPLATE_PRODUCT_PATH="${JPMC_SYSLINUX_PATH}/product.txt.tpl"
    local SYSLINUX_PRODUCT_PATH ; SYSLINUX_PRODUCT_PATH="${BUILT_SYSLINUX_PATH}/product.txt"

    [ -f "${TEMPLATE_PRODUCT_PATH}" ] || { echo "[WARNING] Product template does not exist at expected path: ${TEMPLATE_PRODUCT_PATH}." ; return 1 ; }
    [ -f "${SYSLINUX_PRODUCT_PATH}" ] && { rm -f "${SYSLINUX_PRODUCT_PATH}" || { echo "[WARNING] Could not remove default product.txt added during TS build." ; return 1 ; } }
    
    local  PRODUCT_TEMPLATE ; PRODUCT_TEMPLATE="$(cat ${TEMPLATE_PRODUCT_PATH})"
    export PRODUCT_TEMPLATE_BUILD_DATE="${BUILD_DATE}"
    export PRODUCT_TEMPLATE_VERSION_STRING="${BUILD_VERSION}"
    
    eval "echo \"${PRODUCT_TEMPLATE}\"" > "${SYSLINUX_PRODUCT_PATH}"

    [ -n "$(cat ${SYSLINUX_PRODUCT_PATH})" ] || { echo "[WARNING] Custom product.txt file was not created, or is empty." ; return 1 ; }
}


add_boot_verbosity()
{
    echo "[WARNING] This should be disabled before deployment."
    # Add logic to disable this with a flag or something.
    # Also, the replacement (i.e.: using LM=2) below won't work for every boot image type.

    local -a kernel_configs ; kernel_configs=(                               \
        "/ts/build/boot-images/systemd-boot/loader/entries/thinstation.conf" \ # systemd_boot
        "/ts/build/boot-images/syslinux/boot/syslinux/syslinux.cfg"          \ # syslinux
    )

    for config in ${kernel_configs[*]} ; do

        [ -f "${config}" ] && sed --in-place 's/LM=2/LM=2  loglevel=8  systemd.show_status=true  udev.log_priority=8  rd.systemd.show_status=true  rd.udev.log_priority=8  /' "${config}"

    done
}


####
# Do the JPMC pre-build things.
##

echo
echo "Checking build environment time zone."
echo
adjust_timezone



####
# Do the TS build.
##


echo
echo "Starting ThinStation build."
echo
build_thinstation || { echo "[ERROR] ThinStation build failed... script will now exit.  Please check for errors above." ; exit 1 ; }



####
# Do the JPMC post-build things.
##


echo
echo "Adding and configuring SYSLINUX font, using ${JPMC_CONSOLE_FONT_FILE}."
echo
copy_syslinux_font && add_syslinux_font_directive


echo
echo "Customizing SYSLINUX boot text with date ${BUILD_DATE} and version ${BUILD_VERSION}"
echo
edit_syslinux_product_text


echo
echo "Adding boot verbosity to kernel options"
echo
add_boot_verbosity

